<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mealme.mapper.ChartMapper">

    <select id="selectUserInfo" resultType="UserDto">
        SELECT USER_NUMBER, TO_CHAR(USER_BIRTH, 'YYYY-MM-DD') AS USER_BIRTH, USER_HEIGHT, USER_GENDER, USER_WEIGHT, USER_COMMENT FROM TBL_USER
        WHERE USER_NUMBER = #{userNumber}
    </select>
    
    <select id="selectFoodInfo" resultType="FoodVo">
        SELECT TBL_BOARD.BOARD_NUMBER, TBL_BOARD.USER_NUMBER,TBL_BOARD.MEAL_TIME, TBL_FOOD.FOOD_NUMBER,
               TBL_FOOD.FOOD_NAME, TBL_FOOD.FOOD_WEIGHT, TBL_FOOD.FOOD_SERVING, TBL_FOOD.FOOD_KCAL, TBL_FOOD.FOOD_CARBOHYDRATE,
               TBL_FOOD.FOOD_PROTEIN, TBL_FOOD.FOOD_FAT, TBL_FOOD.FOOD_SUGARS, TBL_FOOD.FOOD_SODIUM, TBL_FOOD.FOOD_CHOLESTEROL,
               TBL_FOOD.FOOD_FATTY_ACID, TBL_FOOD.FOOD_TRANS_FAT, TBL_MEAL_CODE.MEAL_CODE_NUMBER, TBL_MEAL_CODE.MEAL_NAME
        FROM TBL_FOOD JOIN TBL_BOARD ON TBL_FOOD.BOARD_NUMBER = TBL_BOARD.BOARD_NUMBER
            JOIN TBL_MEAL_CODE ON TBL_BOARD.MEAL_CODE_NUMBER = TBL_MEAL_CODE.MEAL_CODE_NUMBER
        WHERE TBL_BOARD.USER_NUMBER = #{userNumber} AND TRUNC(TBL_BOARD.MEAL_TIME) = TO_DATE(#{mealTime})
    </select>

    <select id="selectDaily" resultType="DailyTotalVo">
        SELECT TO_CHAR(TB.MEAL_TIME, 'YYYY-MM-DD') AS MEAL_DATE,
               SUM(FOOD_KCAL) AS TOTAL_FOOD_KCAL,
               SUM(FOOD_CARBOHYDRATE) AS TOTAL_FOOD_CARBOHYDRATE,
               SUM(FOOD_PROTEIN) AS TOTAL_FOOD_PROTEIN,
               SUM(FOOD_FAT) AS TOTAL_FOOD_FAT,
               SUM(FOOD_SUGARS) AS TOTAL_FOOD_SUGARS,
               SUM(FOOD_SODIUM) AS TOTAL_FOOD_SODIUM,
               SUM(FOOD_CHOLESTEROL) AS TOTAL_FOOD_CHOLESTEROL,
               SUM(FOOD_FATTY_ACID) AS TOTAL_FOOD_FATTY_ACID,
               SUM(FOOD_TRANS_FAT) AS TOTAL_FOOD_TRANS_FAT
        FROM TBL_FOOD TF JOIN TBL_BOARD TB
                              ON TF.BOARD_NUMBER = TB.BOARD_NUMBER
        WHERE USER_NUMBER = #{userNumber} AND TB.MEAL_TIME BETWEEN TRUNC(sysdate) - 6 AND sysdate
        GROUP BY TO_CHAR(TB.MEAL_TIME, 'YYYY-MM-DD')
        ORDER BY TO_CHAR(TB.MEAL_TIME, 'YYYY-MM-DD') DESC
    </select>

    <select id="selectWeekly" resultType="DailyTotalVo">
        SELECT TO_CHAR(TRUNC(TB.MEAL_TIME, 'IW'), 'YYYY-MM-DD') AS MEAL_DATE,
        COUNT(DISTINCT TO_CHAR(TB.MEAL_TIME, 'YYYY-MM-DD')) AS COUNT_MEAL_TIME,
        SUM(FOOD_KCAL) AS TOTAL_FOOD_KCAL,
        SUM(FOOD_CARBOHYDRATE) AS TOTAL_FOOD_CARBOHYDRATE,
        SUM(FOOD_PROTEIN) AS TOTAL_FOOD_PROTEIN,
        SUM(FOOD_FAT) AS TOTAL_FOOD_FAT,
        SUM(FOOD_SUGARS) AS TOTAL_FOOD_SUGARS,
        SUM(FOOD_SODIUM) AS TOTAL_FOOD_SODIUM,
        SUM(FOOD_CHOLESTEROL) AS TOTAL_FOOD_CHOLESTEROL,
        SUM(FOOD_FATTY_ACID) AS TOTAL_FOOD_FATTY_ACID,
        SUM(FOOD_TRANS_FAT) AS TOTAL_FOOD_TRANS_FAT
        FROM TBL_FOOD TF
        JOIN TBL_BOARD TB ON TF.BOARD_NUMBER = TB.BOARD_NUMBER
        WHERE USER_NUMBER = #{userNumber}
        AND <![CDATA[
              (
        (TB.MEAL_TIME >= TRUNC(CURRENT_TIMESTAMP, 'IW') - INTERVAL '28' DAY AND TB.MEAL_TIME < TRUNC(CURRENT_TIMESTAMP, 'IW'))
        OR TB.MEAL_TIME > TRUNC(CURRENT_TIMESTAMP, 'IW')
        )
        ]]>
        GROUP BY TRUNC(TB.MEAL_TIME, 'IW')
        ORDER BY TRUNC(TB.MEAL_TIME, 'IW') DESC
    </select>

    <select id="selectMonthly" resultType="DailyTotalVo">
        SELECT TO_CHAR(TRUNC(TB.MEAL_TIME, 'MM'), 'YYYY-MM') AS MEAL_DATE,
               COUNT(DISTINCT TO_CHAR(TB.MEAL_TIME, 'YYYY-MM-DD')) AS COUNT_MEAL_TIME,
               SUM(FOOD_KCAL) AS TOTAL_FOOD_KCAL,
               SUM(FOOD_CARBOHYDRATE) AS TOTAL_FOOD_CARBOHYDRATE,
               SUM(FOOD_PROTEIN) AS TOTAL_FOOD_PROTEIN,
               SUM(FOOD_FAT) AS TOTAL_FOOD_FAT,
               SUM(FOOD_SUGARS) AS TOTAL_FOOD_SUGARS,
               SUM(FOOD_SODIUM) AS TOTAL_FOOD_SODIUM,
               SUM(FOOD_CHOLESTEROL) AS TOTAL_FOOD_CHOLESTEROL,
               SUM(FOOD_FATTY_ACID) AS TOTAL_FOOD_FATTY_ACID,
               SUM(FOOD_TRANS_FAT) AS TOTAL_FOOD_TRANS_FAT
        FROM TBL_FOOD TF
                 JOIN TBL_BOARD TB ON TF.BOARD_NUMBER = TB.BOARD_NUMBER
        WHERE USER_NUMBER = #{userNumber}
          AND (TB.MEAL_TIME >= TRUNC(CURRENT_TIMESTAMP, 'MM') - INTERVAL '6' MONTH)
        GROUP BY TRUNC(TB.MEAL_TIME, 'MM')
        ORDER BY TRUNC(TB.MEAL_TIME, 'MM') DESC
    </select>

    <select id="getMealList" resultType="mealVo">
    SELECT
        B.BOARD_NUMBER,
        B.USER_NUMBER,
        TO_CHAR(B.MEAL_TIME, 'YYYY-MM-DD') AS MEAL_DATE,
        TO_CHAR(B.MEAL_TIME, 'HH24:MI') AS MEAL_TIME,
        BF.FILE_NUMBER,
        BF.FILE_NAME,
        BF.FILE_UPLOAD_PATH,
        BF.FILE_UUID,
        F.MEAL_TOTAL_KCAL
FROM
    TBL_BOARD B
        LEFT JOIN
    (
        SELECT
            FILE_NUMBER,
            FILE_UPLOAD_PATH,
            FILE_UUID,
            FILE_NAME,
            BOARD_NUMBER,
            RANK() OVER (PARTITION BY BOARD_NUMBER ORDER BY FILE_NUMBER) RK
        FROM
            TBL_BOARD_FILE F
    ) BF ON B.BOARD_NUMBER = BF.BOARD_NUMBER AND BF.RK = 1
        LEFT JOIN
    (
        SELECT
            BOARD_NUMBER,
            SUM(FOOD_KCAL) AS MEAL_TOTAL_KCAL
        FROM
            TBL_FOOD
        GROUP BY
            BOARD_NUMBER
    ) F ON B.BOARD_NUMBER = F.BOARD_NUMBER
WHERE
        B.USER_NUMBER = #{userNumber}
and     TO_CHAR(B.MEAL_TIME, 'YYYY-MM-DD') = #{mealTime}
ORDER BY
    MEAL_DATE,
    MEAL_TIME
    </select>

    <select id="selectMealCodeNumberSum" resultType="TodayKcalSumVo">
        SELECT (SELECT SUM(FOOD_KCAL) AS TOTAL_FOOD_KCAL
                FROM TBL_FOOD F
                         JOIN TBL_BOARD B ON F.BOARD_NUMBER = B.BOARD_NUMBER
                WHERE USER_NUMBER = #{userNumber} AND TRUNC(MEAL_TIME) = TO_DATE(#{mealTime}) AND MEAL_CODE_NUMBER = 10) AS BREAKFAST_TOTAL,
               (SELECT SUM(FOOD_KCAL) AS TOTAL_FOOD_KCAL
                FROM TBL_FOOD F
                         JOIN TBL_BOARD B ON F.BOARD_NUMBER = B.BOARD_NUMBER
                WHERE USER_NUMBER = #{userNumber} AND TRUNC(MEAL_TIME) = TO_DATE(#{mealTime}) AND MEAL_CODE_NUMBER = 20) AS LUNCH_TOTAL,
               (SELECT SUM(FOOD_KCAL) AS TOTAL_FOOD_KCAL
                FROM TBL_FOOD F
                         JOIN TBL_BOARD B ON F.BOARD_NUMBER = B.BOARD_NUMBER
                WHERE USER_NUMBER = #{userNumber} AND TRUNC(MEAL_TIME) = TO_DATE(#{mealTime}) AND MEAL_CODE_NUMBER = 30) AS DINNER_TOTAL,
               (SELECT SUM(FOOD_KCAL) AS TOTAL_FOOD_KCAL
                FROM TBL_FOOD F
                         JOIN TBL_BOARD B ON F.BOARD_NUMBER = B.BOARD_NUMBER
                WHERE USER_NUMBER = #{userNumber} AND TRUNC(MEAL_TIME) = TO_DATE(#{mealTime}) AND MEAL_CODE_NUMBER = 40) AS SNACK_TOTAL
        FROM DUAL
    </select>



</mapper>